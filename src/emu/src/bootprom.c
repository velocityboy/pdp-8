#include <assert.h>
#include <stdint.h>
#include <stdio.h>
#include "bootprom.h"

static const uint16_t OP_LOADADDR = 0x8000;
static const uint16_t OP_LOADEX = 0x4000;
static const uint16_t OP_DEPOSIT = 0x2000;
static const uint16_t OP_START = 0x1000;

static uint8_t prom_158a2[256] = {
  0010,0000,0005,0000,0010,0010,0005,0000,0010,0000,0005,0000,0010,0010,0005,0000,
  0010,0015,0004,0000,0002,0000,0002,0017,0002,0015,0002,0015,0002,0017,0002,0016,
  0002,0000,0002,0016,0002,0017,0002,0017,0002,0017,0002,0016,0002,0016,0002,0016,
  0002,0017,0002,0001,0002,0001,0002,0016,0002,0001,0002,0004,0002,0000,0002,0004,
  0002,0017,0002,0000,0002,0001,0002,0017,0002,0001,0002,0001,0002,0017,0002,0017,
  0002,0016,0011,0015,0010,0001,0004,0000,0002,0010,0002,0016,0002,0001,0002,0012,
  0002,0001,0002,0016,0002,0001,0011,0001,0010,0001,0004,0000,0002,0005,0002,0003,
  0002,0016,0002,0010,0002,0002,0002,0002,0002,0004,0002,0016,0002,0002,0002,0016,
  0002,0002,0002,0010,0002,0002,0002,0003,0002,0002,0002,0003,0002,0003,0002,0001,
  0002,0016,0002,0002,0002,0000,0002,0002,0002,0002,0002,0000,0002,0016,0002,0001,
  0002,0016,0002,0002,0002,0001,0002,0001,0011,0001,0010,0016,0004,0000,0002,0010,
  0002,0010,0002,0011,0002,0016,0002,0016,0011,0016,0010,0000,0004,0000,0002,0011,
  0002,0010,0002,0014,0002,0014,0002,0014,0002,0010,0002,0013,0002,0014,0002,0010,
  0002,0010,0002,0011,0002,0010,0002,0014,0002,0014,0002,0014,0002,0010,0002,0000,
  0002,0001,0002,0011,0002,0001,0002,0011,0002,0001,0002,0011,0002,0011,0002,0010,
  0002,0016,0002,0000,0002,0011,0002,0010,0002,0015,0002,0006,0002,0015,0011,0000,
};

static uint8_t prom_159a2[256] = {
  0000,0000,0000,0000,0000,0000,0000,0000,0004,0000,0000,0000,0010,0000,0000,0000,
  0017,0017,0000,0000,0014,0014,0006,0016,0016,0006,0002,0017,0004,0016,0012,0001,
  0014,0011,0012,0016,0006,0001,0002,0001,0006,0011,0002,0005,0006,0017,0002,0005,
  0006,0007,0014,0012,0014,0011,0012,0017,0014,0016,0016,0006,0016,0006,0017,0010,
  0012,0014,0016,0006,0014,0011,0012,0007,0014,0014,0017,0000,0007,0016,0006,0016,
  0012,0016,0017,0017,0000,0003,0000,0000,0004,0000,0015,0005,0000,0003,0017,0000,
  0012,0004,0015,0003,0012,0011,0000,0004,0000,0004,0000,0000,0016,0006,0002,0000,
  0015,0011,0016,0001,0010,0013,0010,0013,0016,0004,0015,0015,0012,0014,0015,0014,
  0017,0010,0017,0010,0012,0006,0002,0000,0016,0001,0002,0001,0006,0000,0012,0004,
  0015,0011,0010,0013,0006,0002,0004,0010,0012,0007,0000,0000,0015,0013,0012,0013,
  0015,0012,0013,0013,0016,0004,0014,0010,0000,0013,0017,0010,0000,0000,0017,0000,
  0015,0003,0015,0002,0012,0012,0013,0012,0017,0010,0010,0000,0000,0000,0002,0017,
  0002,0006,0015,0004,0015,0006,0015,0003,0012,0004,0016,0004,0015,0002,0017,0010,
  0006,0011,0007,0016,0002,0005,0015,0004,0015,0006,0015,0001,0012,0016,0016,0002,
  0017,0010,0003,0016,0016,0002,0007,0016,0017,0000,0004,0016,0004,0015,0012,0015,
  0016,0006,0016,0002,0006,0015,0012,0001,0017,0017,0007,0017,0017,0010,0010,0000,
};

static uint16_t prom[sizeof(prom_158a2)/2];
static int prom_size = sizeof(prom)/sizeof(prom[0]);

static int interleaved = 0;

static void interleave_proms() {
  if (interleaved) {
    return;
  }

  assert(sizeof(prom_158a2) == sizeof(prom_159a2));
  uint8_t *p8 = prom_158a2;
  uint8_t *p9 = prom_159a2;
  uint16_t *pw = prom;

  for (int i = 0; i < sizeof(prom_158a2); i += 2) {
    *pw++ =
      (p8[i] << 12) |
      (p9[i] << 8) |
      (p8[i+1] << 4) |
      p9[i+1];
  }

  interleaved = 1;
}

void emu_run_bootprom(pdp8_t *pdp8, int addr) {
  if (addr >= prom_size) {
    printf("%o is out of range of the boot PROM\n", addr);
    return;
  }

  interleave_proms();

  uint16_t depaddr = 0;

  while (1) {
    uint16_t w = prom[addr++];
    if (w & OP_LOADADDR) {
      depaddr = (depaddr & ~07777) | (w & 07777);
    }

    if (w & OP_LOADEX) {
      depaddr = (depaddr & 07777) | ((w & 07) << 12);
    }

    if (w & OP_DEPOSIT) {
      pdp8->core[depaddr] = w & 07777;
      depaddr = (depaddr + 1) & 077777;
    }

    if (w & OP_START) {
      pdp8->ibr = depaddr & 070000;
      pdp8->ifr = depaddr & 070000;
      pdp8->pc = depaddr & 007777;
      break;
    }

    if (addr >= prom_size) {
      printf("microcode ran off end of prom. stoppped.\n");
    }
  }
}
